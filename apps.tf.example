module "apps_azure_site1" {
  count                           = 1
  source                          = "./apps"
  domains                         = ["workload.site1"]
  f5xc_tenant                     = var.f5xc_tenant
  origin_port                     = 8080
  app_site_name                   = format("%s-%s-apps-azure-site1-%s", var.project_prefix, var.project_name, var.project_suffix)
  f5xc_namespace                  = module.namespace.namespace["name"]
  advertise_port                  = 80
  f5xc_origin_pool_origin_servers = {
    private_ip = [
      {
        ip              = one(module.azure-site-1a[*].workload.private_ip)
        inside_network  = true
        outside_network = false
        site_locator    = {
          site = {
            namespace = var.f5xc_namespace
            name      = local.azure-site-1a
            tenant    = var.f5xc_tenant
          }
        }
      },
      {
        ip              = one(module.azure-site-1b[*].workload.private_ip)
        inside_network  = true
        outside_network = false
        site_locator    = {
          site = {
            namespace = var.f5xc_namespace
            name      = local.azure-site-1b
            tenant    = var.f5xc_tenant
          }
        }
      }
    ]
  }
  advertise_vip   = "10.64.15.254"
  advertise_sites = local.advertise_sites
  providers       = {
    volterra = volterra.default
  }

}

module "apps_aws_site1" {
  count                           = 1
  source                          = "./apps"
  domains                         = ["workload.site2"]
  origin_port                     = 8080
  f5xc_tenant                     = var.f5xc_tenant
  app_site_name                   = format("%s-%s-apps-aws-site1-%s", var.project_prefix, var.project_name, var.project_suffix)
  advertise_port                  = 80
  f5xc_namespace                  = module.namespace.namespace["name"]
  f5xc_origin_pool_origin_servers = {
    "private_ip" = [
      {
        ip              = one(module.aws-site-1a[*].workload["private_ip"])
        inside_network  = true
        outside_network = false
        site_locator    = {
          site = {
            namespace = var.f5xc_namespace
            name      = local.aws-site-1a
            tenant    = var.f5xc_tenant
          }
        }
      },
      {
        ip              = one(module.aws-site-1b[*].workload["private_ip"])
        inside_network  = true
        outside_network = false
        site_locator    = {
          site = {
            namespace = var.f5xc_namespace
            name      = local.aws-site-1b
            tenant    = var.f5xc_tenant
          }
        }
      }
    ]
  }
  advertise_vip   = "10.64.15.254"
  advertise_sites = local.advertise_sites
  providers       = {
    volterra = volterra.default
  }
}

module "apps_gcp_site1" {
  count                           = 1
  source                          = "./apps"
  domains                         = ["workload.site3"]
  f5xc_tenant                     = var.f5xc_tenant
  origin_port                     = 8080
  app_site_name                   = format("%s-%s-apps-gcp-site1-%s", var.project_prefix, var.project_name, var.project_suffix)
  f5xc_namespace                  = module.namespace.namespace["name"]
  advertise_port                  = 80
  f5xc_origin_pool_origin_servers = {
    "private_ip" : [
      {
        ip              = one(module.gcp-site-1a[*].workload.private_ip)
        inside_network  = true
        outside_network = false
        site_locator    = {
          site = {
            namespace = var.f5xc_namespace
            name      = one(module.gcp-site-1a[*].site["name"])
            tenant    = var.f5xc_tenant
          }
        }
      },
      {
        ip              = one(module.gcp-site-1b[*].workload.private_ip)
        inside_network  = true
        outside_network = false
        site_locator    = {
          site = {
            namespace = var.f5xc_namespace
            name      = one(module.gcp-site-1b[*].site["name"])
            tenant    = var.f5xc_tenant
          }
        }
      }
    ]
  }
  advertise_vip   = "10.64.15.254"
  advertise_sites = local.advertise_sites
  providers       = {
    volterra = volterra.default
  }
}